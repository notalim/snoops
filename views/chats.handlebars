<main>
    <div class="chat-container">
        {{#if chats}}
        <div class="all-chats">
            {{#each chats}}
            <div class="chat">
                <p class="uid">User {{this.userId}}</p>
                <p class="acid">User {{this.centerId}}</p>
            </div>
            {{/each}}
        </div>
        <div id="current-chat" class="current-chat"></div>
        <div id="chatTextDiv">
            <input class="textBox" type="text" name="sentMessage" id="sentMessage">
            <button class="button" type="submit" id="sendButton">Submit</button>
        </div>
        {{/if}}
    </div>
    <script type="module">
        let chats = document.getElementsByClassName("chat");
        let currentChat = document.getElementById("current-chat");
        let sendMessage = document.getElementById("sendButton");
        let chatTextBox = document.getElementById("sentMessage");
        let currChatInfo;

        for(let chat of chats){
            let aCenterID = chat.getElementsByClassName("acid")[0];
            let requestConfig = {
                method: 'GET',
                url: `/acenters/${aCenterID.textContent.split(" ")[1]}`
            };
            (function ($) {
                $.ajax(requestConfig).then(function (responseMessage) {
                    let aCenterName = document.createElement("p");
                    aCenterName.textContent = responseMessage.name;
                    chat.appendChild(aCenterName)
                })
            })(window.jQuery);
            chat.addEventListener("click", async() =>{
                for(let _chat of chats){
                    if(_chat != chat){
                        _chat.style.color = "black"
                    }
                }
                while(currentChat.childElementCount > 0){
                    currentChat.removeChild(currentChat.lastChild);
                }
                currChatInfo = chat;
                console.log(chat);
                let acid = chat.getElementsByClassName("acid");
                let uid = chat.getElementsByClassName("uid");

                let acidText = acid[0].textContent.split(" ")[1];

                let uidText = uid[0].textContent.split(" ")[1];

                chat.style.color = "red";

                let requestConfig = {
                    method: 'GET',
                    url: `/chats/user/${uidText}/${acidText}`
                };
                (function ($) {
                    $.ajax(requestConfig).then(function (responseMessage){
                        console.log(responseMessage);
                        let messages = responseMessage.messages;
                        for(let message of messages){
                            if(message.senderId === uidText){
                                console.log("User: " + message.messageContent)
                                let messageDiv = document.createElement("div");
                                let timeP = document.createElement("span");
                                let messageP = document.createElement("p");
                                timeP.textContent = message.messageTime;
                                messageP.textContent = message.messageContent;
                                messageDiv.appendChild(timeP);
                                messageDiv.appendChild(messageP);
                                currentChat.appendChild(messageDiv);
                                messageDiv.classList.add("userMessageDiv");
                                messageP.classList.add("userMessage");
                                timeP.classList.add("userMessageTime");
                            }else{
                                console.log("Acenter: " + message.messageContent);
                                let messageDiv = document.createElement("div");
                                let timeP = document.createElement("span");
                                let messageP = document.createElement("p");
                                messageP.textContent = message.messageContent;
                                timeP.textContent = message.messageTime;
                                messageDiv.appendChild(messageP);
                                messageDiv.appendChild(timeP);
                                currentChat.appendChild(messageDiv);
                                messageDiv.classList.add("acenterMessageDiv");
                                messageP.classList.add("acenterMessage");
                                timeP.classList.add("acenterMessageTime");
                            }
                        }
                    })
                })(window.jQuery);
                currentChat.scrollTop = 0;
                console.log(currentChat.scrollTo(10000, 1000))
            })
        }
        //add the same loading ajax request but on an interval
        //this might be prone to injections
        sendMessage.addEventListener("click", (event) => {
            event.preventDefault();
            let chatText = chatTextBox.value;
            console.log(chatText)
            console.log(chatTextBox)
            try{
                if(!chatText){
                    throw `You must supply a message`;
                }
                if(chatText.trim().length === 0){
                    throw `You must send a non-empty message`;
                }
                chatText = chatText.trim();
            }catch(e){
                console.log(e);
            }
            let acid = currChatInfo.getElementsByClassName("acid");
            let uid = currChatInfo.getElementsByClassName("uid");

            let acidText = acid[0].textContent.split(" ")[1];

            let uidText = uid[0].textContent.split(" ")[1];

            let requestConfig = {
                method: 'PUT',
                url: `/chats/user/${uidText}/${acidText}`,
                contentType: 'application/json',
                data: JSON.stringify({
                    message: chatText,
                })
            };
            (function($){
                $.ajax(requestConfig).then(function (responseMessage) {
                    console.log(responseMessage.message.messageContent);
                    let messageDiv = document.createElement("div");
                    let messageP = document.createElement("p");
                    messageP.textContent = responseMessage.message.messageContent;
                    messageDiv.appendChild(messageP);
                    currentChat.appendChild(messageDiv);
                    messageDiv.classList.add("userMessageDiv");
                    messageP.classList.add("userMessage");
                })
            })(window.jQuery);

        })
    </script>
</main>